<!DOCTYPE html>
<html>
<head>
    <title>ShinobiWay</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; font-family: Arial, sans-serif; }
        button { background-color: #ff4500; color: #fff; padding: 5px 10px; margin: 5px; border: none; cursor: pointer; }
        button:hover { background-color: #ff6347; }
        #log { height: 100px; overflow-y: auto; background-color: #2f2f2f; padding: 5px; }
        #output { padding: 5px; }
        .battle-ready { color: #00ff00; }
        .genin { color: #ffd700; }
    </style>
</head>
<body>
    <div id="player-status">Shinobi [HP: <span class="player-hp">10/10</span>]</div>
    <div id="enemy-status">Enemy [HP: <span class="enemy-hp">0/0</span>]</div>
    <div id="skill-count">Skill cards: 0 | Gold: 0</div>
    <div id="output">Welcome to ShinobiWay!</div>
    <div id="start-controls">
        <button id="start-button" onclick="startGame()">Start Game</button>
    </div>
    <div id="style-controls"></div>
    <div id="jutsu-controls"></div>
    <div id="skill-controls"></div>
    <div id="main-controls"></div>
    <div id="log">Log started...</div>

    <script>
        let game = {
            player: { name: "Shinobi", hp: 10, maxHp: 10, skills: [], skillInventory: ["Barrage"], gold: 0, rank: "Student", styles: [], styleRanks: { Fire: "D-Rank", Genjutsu: "D-Rank", Earth: "D-Rank", Lightning: "D-Rank", Feral: "D-Rank", Ninjutsu: "D-Rank", Taijutsu: "D-Rank" }, skillCounts: { "Barrage": 1, "Shock Field Jutsu": 0, "Lightning Blade Jutsu": 0, "Fireball Jutsu": 0, "Flame Throw Jutsu": 0, "Rock Barrier Jutsu": 0, "Rock Smash Jutsu": 0, "Demonic Vision Jutsu": 0, "Genjutsu Release Jutsu": 0, "Shadow Clone Jutsu": 0, "Dynamic Entry Jutsu": 0, "Falcon Drop Jutsu": 0, "Substitution Jutsu": 0, "Clone Jutsu": 0 } },
            gameState: "start",
            skillRanks: {
                "Shock Field Jutsu": "C-Rank", "Lightning Blade Jutsu": "B-Rank", "Fireball Jutsu": "C-Rank",
                "Flame Throw Jutsu": "B-Rank", "Rock Barrier Jutsu": "C-Rank", "Rock Smash Jutsu": "B-Rank",
                "Demonic Vision Jutsu": "C-Rank", "Genjutsu Release Jutsu": "B-Rank", "Shadow Clone Jutsu": "C-Rank",
                "Dynamic Entry Jutsu": "C-Rank", "Falcon Drop Jutsu": "B-Rank", "Substitution Jutsu": "D-Rank",
                "Clone Jutsu": "D-Rank", "Barrage": "D-Rank"
            },
            goldValues: { "D-Rank": 5, "C-Rank": 10, "B-Rank": 50, "A-Rank": 100, "S-Rank": 500 },
            asciiArt: {
                battleStart: "👊💥 BATTLE BEGINS! 👊💥\nShinobi vs. Enemy!",
                "Shock Field Jutsu": "⚡️ Shock Field!",
                "Lightning Blade Jutsu": "⚡ Blade Strike!",
                "Fireball Jutsu": "🔥 Fireball Strike!",
                "Flame Throw Jutsu": "🔥🔥 Flame Burst!",
                "Rock Barrier Jutsu": "🪨 Rock Shield!",
                "Rock Smash Jutsu": "🪨💥 Rock Smash!",
                "Demonic Vision Jutsu": "💀 Doom Strikes!",
                "Genjutsu Release Jutsu": "🌫️ Mind Freed!",
                "Shadow Clone Jutsu": "🌫️ Clone Appears!",
                "Dynamic Entry Jutsu": "💥 Dynamic Kick!",
                "Falcon Drop Jutsu": "🦅 Falcon Strike!",
                "Substitution Jutsu": "🌫️ Substitution!",
                "Clone Jutsu": "🌫️ Illusion Clone!",
                "Barrage": "💥 Rapid Assault!"
            },
            dotEffects: {
                "Flame Throw Jutsu": { baseDamage: 2, duration: 3 },
                "Demonic Vision Jutsu": { baseDamage: 1, duration: 5 }
            },
            jutsuRequirements: {
                "Shock Field Jutsu": { styles: ["Lightning"], minRank: "C-Rank" },
                "Lightning Blade Jutsu": { styles: ["Lightning"], minRank: "B-Rank" },
                "Fireball Jutsu": { styles: ["Fire"], minRank: "C-Rank" },
                "Flame Throw Jutsu": { styles: ["Fire"], minRank: "B-Rank" },
                "Rock Barrier Jutsu": { styles: ["Earth"], minRank: "C-Rank", attributes: ["Support"] },
                "Rock Smash Jutsu": { styles: ["Earth"], minRank: "B-Rank" },
                "Demonic Vision Jutsu": { styles: ["Genjutsu"], minRank: "C-Rank" },
                "Genjutsu Release Jutsu": { styles: ["Genjutsu"], minRank: "B-Rank", attributes: ["Support"] },
                "Shadow Clone Jutsu": { styles: ["Ninjutsu"], minRank: "C-Rank", attributes: ["Support"] },
                "Dynamic Entry Jutsu": { styles: ["Taijutsu"], minRank: "C-Rank" },
                "Falcon Drop Jutsu": { styles: ["Taijutsu"], minRank: "B-Rank" },
                "Substitution Jutsu": { styles: ["Ninjutsu", "Taijutsu"], attributes: ["Support"] },
                "Clone Jutsu": { styles: ["Genjutsu"], attributes: ["Support"] },
                "Barrage": {}
            },
            rankLimits: { "Student": 5, "Genin": 10, "Chunin": 15, "Jonin": 20, "Kage": 25 }
        };

        function log(msg) {
            const el = document.getElementById('log');
            el.innerHTML += '<br>' + msg;
        }

        function updateSkillCount() {
            let totalCards = 0;
            for (let skill in game.player.skillCounts) {
                totalCards += game.player.skillCounts[skill];
            }
            document.getElementById("skill-count").innerText = `Skill cards: ${totalCards} | Gold: ${game.player.gold}`;
        }

        function startGame() {
            log('Starting game at ' + new Date().toLocaleTimeString() + '...');
            if (game.gameState === "start") {
                game.output = ["Train to earn gold and skills! Aim for 10 skills to become a Genin!"];
                document.getElementById("output").innerHTML = game.output.join("<br>");
                game.gameState = "chooseStyles";
                log('Setting up style selection...');
                setupStyleButtons();
                updateSkillCount(); // Update with initial Barrage
                document.getElementById("start-button").style.display = "none";
            } else {
                log('Game already started, state: ' + game.gameState);
            }
        }

        function setupStyleButtons() {
            let controls = document.getElementById("style-controls");
            controls.innerHTML = "";
            let allStyles = ["Fire", "Genjutsu", "Earth", "Lightning", "Feral", "Ninjutsu", "Taijutsu"];
            allStyles.forEach(style => {
                let button = document.createElement("button");
                button.innerText = style;
                button.onclick = function() { selectStyle(style); };
                controls.appendChild(button);
                log('Added ' + style + ' button');
            });
        }

        function selectStyle(style) {
            log('Selecting ' + style + '...');
            if (game.player.styles.length < 2 && game.gameState === "chooseStyles") {
                if (confirm("Select " + style + "?")) {
                    game.player.styles.push(style);
                    game.player.styleRanks[style] = upgradeRank(game.player.styleRanks[style]); // Upgrade to C-Rank
                    log(style + ' added as a style with rank upgraded to ' + game.player.styleRanks[style] + '!');
                    if (game.player.styles.length === 2) {
                        log('Both styles selected, proceeding to initial jutsu selection...');
                        document.getElementById("style-controls").innerHTML = "";
                        setupInitialJutsuSelection();
                    } else {
                        setupStyleButtons(); // Refresh
                    }
                } else {
                    log(style + ' selection canceled.');
                }
            } else {
                log('Style selection invalid or complete, state: ' + game.gameState);
            }
        }

        function upgradeRank(rank) {
            const ranks = ["D-Rank", "C-Rank", "B-Rank", "A-Rank", "S-Rank"];
            let currentIndex = ranks.indexOf(rank);
            return currentIndex < ranks.length - 1 ? ranks[currentIndex + 1] : rank;
        }

        function setupInitialJutsuSelection() {
            game.gameState = "chooseInitialJutsu";
            performJutsuSelection(3); // Trigger 3 times for initial 4 cards
        }

        function performJutsuSelection(times) {
            if (times > 0) {
                let controls = document.getElementById("jutsu-controls");
                controls.innerHTML = "";
                let availableJutsu = Object.keys(game.jutsuRequirements).filter(jutsu => {
                    let req = game.jutsuRequirements[jutsu];
                    if (req.minRank) {
                        return req.styles.some(s => game.player.styles.includes(s) && game.player.styleRanks[s] >= req.minRank);
                    }
                    return req.styles ? req.styles.some(s => game.player.styles.includes(s)) : true;
                });
                let randomJutsu = [];
                for (let i = 0; i < 3 && availableJutsu.length > 0; i++) {
                    let index = Math.floor(Math.random() * availableJutsu.length);
                    randomJutsu.push(availableJutsu.splice(index, 1)[0]);
                }
                if (randomJutsu.length > 0) {
                    randomJutsu.forEach(jutsu => {
                        let button = document.createElement("button");
                        button.innerText = jutsu;
                        button.onclick = function() { selectJutsu(jutsu, () => performJutsuSelection(times - 1)); };
                        controls.appendChild(button);
                        log('Added ' + jutsu + ' to selection');
                    });
                } else {
                    log('No jutsu available based on styles and ranks.');
                    showMainScreen();
                }
            } else {
                log('Initial jutsu selection complete, returning to main screen...');
                showMainScreen();
            }
        }

        function selectJutsu(jutsu, callback) {
            log('Selecting ' + jutsu + '...');
            if (game.gameState === "chooseInitialJutsu") {
                let count = game.player.skillCounts[jutsu] || 0;
                if (count < 4) {
                    game.player.skillInventory.push(jutsu);
                    game.player.skillCounts[jutsu] = count + 1;
                    log(jutsu + ' added to skill inventory!');
                    updateSkillCount();
                    document.getElementById("jutsu-controls").innerHTML = "";
                    if (callback) callback();
                } else {
                    let rank = game.skillRanks[jutsu] || "D-Rank";
                    let goldGain = game.goldValues[rank];
                    game.player.gold += goldGain;
                    log(`5th ${jutsu} converted to ${goldGain} gold!`);
                    updateSkillCount();
                    document.getElementById("jutsu-controls").innerHTML = "";
                    if (callback) callback();
                }
            }
        }

        function showMainScreen() {
            game.gameState = "main";
            let controls = document.getElementById("main-controls");
            controls.innerHTML = "";
            ["Train", "Manage Skills"].forEach(option => {
                let button = document.createElement("button");
                button.innerText = option;
                button.onclick = function() { handleMainOption(option); };
                controls.appendChild(button);
                log('Added ' + option + ' option');
            });
        }

        function handleMainOption(option) {
            log('Selected option: ' + option);
            if (option === "Train") {
                log('Entering battle...');
                document.getElementById("output").innerHTML += `<br><span class="battle-ready">Battle ended!</span>`;
                performJutsuSelection(1); // Post-battle: 1 selection of 3
            } else if (option === "Manage Skills") {
                updateSkillControls();
            }
        }

        function updateSkillControls() {
            let controls = document.getElementById("skill-controls");
            controls.innerHTML = "";
            if (game.gameState === "main") {
                for (let skill in game.player.skillCounts) {
                    for (let i = 0; i < game.player.skillCounts[skill]; i++) {
                        let button = document.createElement("button");
                        button.innerText = `Move ${skill} (${i + 1}) to Inventory`;
                        button.onclick = function() { moveToInventory(skill, i); };
                        controls.appendChild(button);
                        log(`Added button to move ${skill} (${i + 1}) to inventory`);
                    }
                }
                game.player.skillInventory.forEach((skill, index) => {
                    let button = document.createElement("button");
                    button.innerText = `Add ${skill} (${index + 1}) to Active`;
                    button.onclick = function() { moveToActiveSkills(skill, index); };
                    controls.appendChild(button);
                    log(`Added button to move ${skill} (${index + 1}) to active skills`);
                });
            }
        }

        function moveToActiveSkills(skill, index) {
            if (game.player.skills.length < game.rankLimits[game.player.rank]) {
                game.player.skills.push(skill);
                game.player.skillInventory.splice(index, 1);
                log(`${skill} moved to active skills!`);
                updateSkillCount();
                updateSkillControls();
            } else {
                log('Active skills limit reached!');
            }
        }

        function moveToInventory(skill, countIndex) {
            game.player.skillInventory.push(skill);
            game.player.skillCounts[skill]--;
            if (game.player.skillCounts[skill] <= 0) {
                game.player.skills = game.player.skills.filter(s => s !== skill);
            }
            log(`${skill} moved to inventory!`);
            updateSkillCount();
            updateSkillControls();
        }
    </script>
</body>
</html>
