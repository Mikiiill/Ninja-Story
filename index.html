<!DOCTYPE html>
<html>
<head>
    <title>ShinobiWay</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background-image: url('https://mikiiill.github.io/ShinobiWay/Assets/Back.png');
            background-repeat: no-repeat;
            background-size: cover;
            background-color: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .output {
            width: 85%;
            height: 400px;
            background-color: #333;
            overflow-y: auto;
            padding: 10px;
            margin: 10px;
            border: 2px solid #fff;
        }
        .controls {
            width: 80%;
            margin: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .status {
            width: 80%;
            margin: 10px;
            padding: 10px;
            border: 2px solid #fff;
            background-color: #333;
        }
        button {
            background-color: #555;
            color: #fff;
            border: 2px solid #fff;
            padding: 5px 10px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #777;
        }
        button.disabled {
            background-color: #888;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .ninjutsu { background-color: #000080; }
        .genjutsu { background-color: #800080; }
        .taijutsu { background-color: #228b22; }
        .fire { background-color: #ff0000; }
        .lightning { background-color: #ffa500; }
        .earth { background-color: #8b4513; }
        .start-button {
            background-color: #555;
            color: #fff;
            border: 2px solid #fff;
            font-size: 1.5rem;
            padding: 10px 20px;
        }
        .skills-button, .train-button {
            background-color: #555;
            color: #fff;
            border: 2px solid #fff;
            font-size: 1.2rem;
            padding: 5px 10px;
        }
        .output-text-player { color: #00ff00; }
        .output-text-enemy { color: #ff00ff; }
        .output-text-neutral { color: #ccc; }
        .status-burn { color: #ff0000; }
        .status-numb { color: #ffa500; }
        .status-bleed { color: #ff00ff; }
        .status-regen { color: #00ff00; }
        .status-doom { color: #ffffff; }
        .status-shadowcloneeffect { color: #800080; }
        .status-substitution { color: #8b4513; }
        .status-dome { color: #228b22; }
        .sprite { width: 50px; height: 50px; vertical-align: middle; }
        .player-hp { color: #00ff00; }
        .enemy-hp { color: #ff00ff; }
    </style>
</head>
<body onload="resetGameState()">
    <div class="status" id="player-status">Shinobi [HP: <span class="player-hp">10/10</span>]</div>
    <div class="status" id="enemy-status">Enemy [HP: <span class="enemy-hp">0/0</span>]</div>
    <div class="output" id="output">Welcome to ShinobiWay!</div>
    <div class="controls" id="start-controls">
        <button class="start-button" id="start-button" onclick="startGame()">Start Game</button>
    </div>
    <div class="controls" id="style-controls"></div>
    <div class="controls" id="jutsu-controls"></div>
    <div class="controls" id="skill-controls"></div>
    <div class="controls" id="main-controls"></div>

    <script src="Jutsu.js"></script>
    <script src="Characters.js"></script>
    <script src="Battle.js"></script>
    <script>
        let game = {
            player: {
                name: "Shinobi",
                hp: 10,
                maxHp: 10,
                Rank: "Student",
                ninjaStyles: { Ninjutsu: "D-Rank", Taijutsu: "D-Rank", Genjutsu: "D-Rank", Fire: "D-Rank", Lightning: "D-Rank", Earth: "D-Rank", Water: "D-Rank", Wind: "D-Rank", Feral: "D-Rank" },
                skills: [],
                skillInventory: [new Skills().findSkill("Barrage")],
                statusEffects: []
            },
            enemy: null,
            battleNum: 1,
            output: [],
            gameState: "start",
            battleScene: null,
            outputQueue: [],
            isOutputting: false
        };

        function resetGameState() {
            game = {
                player: {
                    name: "Shinobi",
                    hp: 10,
                    maxHp: 10,
                    Rank: "Student",
                    ninjaStyles: { Ninjutsu: "D-Rank", Taijutsu: "D-Rank", Genjutsu: "D-Rank", Fire: "D-Rank", Lightning: "D-Rank", Earth: "D-Rank", Water: "D-Rank", Wind: "D-Rank", Feral: "D-Rank" },
                    skills: [],
                    skillInventory: [new Skills().findSkill("Barrage")],
                    statusEffects: []
                },
                enemy: null,
                battleNum: 1,
                output: [],
                gameState: "start",
                battleScene: null,
                outputQueue: [],
                isOutputting: false
            };
            document.getElementById("output").innerHTML = "Welcome to ShinobiWay!";
            document.getElementById("start-controls").innerHTML = '<button class="start-button" id="start-button" onclick="startGame()">Start Game</button>';
            document.getElementById("style-controls").innerHTML = "";
            document.getElementById("jutsu-controls").innerHTML = "";
            document.getElementById("skill-controls").innerHTML = "";
            document.getElementById("main-controls").innerHTML = "";
            updateStatus();
        }

        function queueOutput(text) {
            game.outputQueue.push(text);
            if (!game.isOutputting) processOutputQueue();
        }

        function processOutputQueue() {
            if (game.outputQueue.length === 0) {
                game.isOutputting = false;
                return;
            }
            game.isOutputting = true;
            let text = game.outputQueue.shift();
            game.output.push(text);
            document.getElementById("output").innerHTML = game.output.join("<br>");
            document.getElementById("output").scrollTop = document.getElementById("output").scrollHeight;
            setTimeout(processOutputQueue, 1000);
        }

        function updateStatus() {
            let playerEffects = [...new Set(game.player.statusEffects.map(e => `<span class="status-${e.name.toLowerCase().replace(" ", "")}">${game.asciiMap[e.name] || ""}</span>`))].join("");
            document.getElementById("player-status").innerHTML = `Shinobi [HP: <span class="player-hp">${game.player.hp}/${game.player.maxHp}</span>] ${playerEffects}`;
            let enemyEffects = game.enemy ? [...new Set(game.enemy.statusEffects.map(e => `<span class="status-${e.name.toLowerCase().replace(" ", "")}">${game.asciiMap[e.name] || ""}</span>`))].join("") : "";
            document.getElementById("enemy-status").innerHTML = game.enemy ? `${game.enemy.name} [HP: <span class="enemy-hp">${game.enemy.hp}/${game.enemy.maxHp}</span>] ${enemyEffects}` : "Enemy [HP: <span class='enemy-hp'>0/0</span>]";
        }

        function updateSkillCount() {
            let totalCards = game.player.skills.length + game.player.skillInventory.length;
            if (totalCards >= 10 && game.player.Rank === "Student") {
                game.player.Rank = "Genin";
                queueOutput("Promoted to Genin!");
            }
        }

        function startGame() {
            game.output = ["Train to earn gold and skills! Aim for 10 skills to become a Genin! Click to choose styles!"];
            document.getElementById("output").innerHTML = game.output.join("<br>");
            game.gameState = "chooseStyles";
            let controls = document.getElementById("style-controls");
            controls.innerHTML = "";
            let styles = ["Ninjutsu", "Genjutsu", "Taijutsu", "Fire", "Lightning", "Earth"];
            styles.forEach((style) => {
                let button = document.createElement("button");
                button.innerText = style;
                button.className = style.toLowerCase();
                button.onclick = () => selectStyle(style, button);
                controls.appendChild(button);
            });
            updateSkillCount();
            document.getElementById("start-controls").innerHTML = "";
        }

        function selectStyle(style, button) {
            if (game.gameState === "chooseStyles" && game.player.ninjaStyles[style] && game.player.ninjaStyles[style] === "D-Rank" && Object.values(game.player.ninjaStyles).filter(r => r !== "D-Rank").length < 2) {
                if (confirm(`Upgrade ${style} to C-Rank?`)) {
                    game.player.ninjaStyles[style] = "C-Rank";
                    queueOutput(`<span class="output-text-${style.toLowerCase()}">${style}</span> trained to C-Rank!`);
                    button.className += " disabled";
                    button.disabled = true;
                    if (Object.values(game.player.ninjaStyles).filter(r => r !== "D-Rank").length === 2) {
                        document.getElementById("style-controls").innerHTML = "";
                        setupInitialJutsuSelection();
                    } else {
                        let remainingPoints = 2 - Object.values(game.player.ninjaStyles).filter(r => r !== "D-Rank").length;
                        queueOutput(`You have ${remainingPoints} point${remainingPoints === 1 ? '' : 's'} remaining to upgrade another style.`);
                    }
                }
            }
        }

        function setupInitialJutsuSelection() {
            game.gameState = "chooseInitialJutsu";
            performJutsuSelection(3);
        }

        function performJutsuSelection(times) {
            if (times > 0) {
                let controls = document.getElementById("jutsu-controls");
                controls.innerHTML = "";
                let skillSet = new Skills();
                let availableJutsu = skillSet.skills.filter(skill => skillSet.canUseSkill(game.player, skill));
                let randomJutsu = [];
                for (let i = 0; i < 3 && availableJutsu.length > 0; i++) {
                    let index = Math.floor(Math.random() * availableJutsu.length);
                    randomJutsu.push(availableJutsu.splice(index, 1)[0]);
                }
                if (randomJutsu.length > 0) {
                    randomJutsu.forEach(jutsu => {
                        let button = document.createElement("button");
                        button.innerText = jutsu.name;
                        button.onclick = function() { selectJutsu(jutsu, () => performJutsuSelection(times - 1)); };
                        controls.appendChild(button);
                    });
                } else {
                    queueOutput('No jutsu available based on styles and ranks.');
                    showMainScreen();
                }
            } else {
                // Add extra Barrage card after initial selection
                let barrageSkill = new Skills().findSkill("Barrage");
                game.player.skillInventory.push(barrageSkill);
                game.player.skillInventory.push(barrageSkill); // Two more for total of 4
                queueOutput("Extra Barrage cards added to your inventory for a total of 4!");
                showMainScreen();
            }
        }

        function selectJutsu(jutsu, callback) {
            if (game.gameState === "chooseInitialJutsu" || game.gameState === "postBattle") {
                if (confirm("Select " + jutsu.name + "?")) {
                    let count = game.player.skills.filter(s => s.name === jutsu.name).length + game.player.skillInventory.filter(s => s.name === jutsu.name).length;
                    if (count < 3 || (game.player.skills.length + game.player.skillInventory.length < 10 && (jutsu.rank === "D-Rank" || jutsu.rank === "C-Rank"))) {
                        game.player.skillInventory.push(jutsu);
                        queueOutput(`${jutsu.name} added to skill inventory!`);
                        updateSkillCount();
                        document.getElementById("jutsu-controls").innerHTML = "";
                        if (callback) callback();
                    } else {
                        game.player.gold += jutsu.rank === "D-Rank" ? 5 : jutsu.rank === "C-Rank" ? 10 : 50;
                        queueOutput(`Extra ${jutsu.name} converted to ${jutsu.rank === "D-Rank" ? 5 : jutsu.rank === "C-Rank" ? 10 : 50} gold due to owning 3 or more!`);
                        updateSkillCount();
                        document.getElementById("jutsu-controls").innerHTML = "";
                        if (callback) callback();
                    }
                }
            }
        }

        function showMainScreen() {
            game.gameState = "main";
            let controls = document.getElementById("main-controls");
            controls.innerHTML = "";
            ["Train", "Manage Skills"].forEach(option => {
                let button = document.createElement("button");
                button.className = option === "Train" ? "train-button" : "skills-button";
                button.innerText = option;
                button.onclick = function() { handleMainOption(option); };
                controls.appendChild(button);
            });
            updateSkillControls();
        }

        function handleMainOption(option) {
            if (option === "Train" && game.gameState !== "battle") {
                startBattle();
            } else if (option === "Manage Skills") {
                if (document.getElementById("skill-controls").innerHTML === "" && game.gameState !== "battle") {
                    updateSkillControls();
                } else {
                    document.getElementById("skill-controls").innerHTML = "";
                }
            }
        }

        function updateSkillControls() {
            let controls = document.getElementById("skill-controls");
            controls.innerHTML = "";
            if (game.gameState === "main") {
                game.player.skillInventory.forEach((skill, index) => {
                    let button = document.createElement("button");
                    button.innerText = `Add ${skill.name} (${index + 1}) to Active`;
                    button.onclick = function() { moveToActiveSkills(skill, index); };
                    controls.appendChild(button);
                });
                game.player.skills.forEach((skill, index) => {
                    let button = document.createElement("button");
                    button.innerText = `Move ${skill.name} (${index + 1}) to Inventory`;
                    button.onclick = function() { moveToInventory(skill, index); };
                    controls.appendChild(button);
                });
            }
        }

        function moveToActiveSkills(skill, index) {
            if (game.gameState !== "battle") {
                let cRankCount = game.player.skills.filter(s => s.rank === "C-Rank").length;
                let bRankCount = game.player.skills.filter(s => s.rank === "B-Rank").length;
                let aRankCount = game.player.skills.filter(s => s.rank === "A-Rank").length;
                let maxSkills = game.player.Rank === "Student" ? 5 : game.player.Rank === "Genin" ? 10 : 15;
                if (game.player.skills.length < maxSkills) {
                    if (skill.rank === "C-Rank" && cRankCount < (game.player.Rank === "Genin" ? 3 : 5) ||
                        skill.rank === "B-Rank" && bRankCount < (game.player.Rank === "Genin" ? 2 : 0) ||
                        skill.rank === "A-Rank" && aRankCount < (game.player.Rank === "Genin" ? 1 : 0) ||
                        skill.rank === "D-Rank") {
                        game.player.skills.push(skill);
                        game.player.skillInventory.splice(index, 1);
                        queueOutput(`${skill.name} moved to active skills!`);
                        updateSkillCount();
                        updateSkillControls();
                    } else {
                        queueOutput(`Rank limit reached for ${skill.rank} skills!`);
                    }
                } else {
                    queueOutput('Active skills limit reached!');
                }
            } else {
                queueOutput('Cannot move skills during battle!');
            }
        }

        function moveToInventory(skill, index) {
            if (game.gameState !== "battle") {
                game.player.skillInventory.push(skill);
                game.player.skills.splice(index, 1);
                queueOutput(`${skill.name} moved to inventory!`);
                updateSkillCount();
                updateSkillControls();
            } else {
                queueOutput('Cannot move skills during battle!');
            }
        }
    </script>
</body>
</html>
